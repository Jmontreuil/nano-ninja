# Code Conventions

This document defines the naming and organisation conventions for this
project. All code written by hand or generated by AI tools must follow
these conventions. When asking Antigravity's Claude to write code, reference
this document at the start of the session.

---

## Naming Conventions

### Signals
**Prefix:** `sig_`
**Format:** `sig_` + snake_case description

```gdscript
signal sig_dash_started(direction)
signal sig_dash_ended
signal sig_dash_ready
signal sig_invulnerability_started
signal sig_invulnerability_ended
signal sig_hit_confirmed
signal sig_leg_destroyed
signal sig_phase_changed(phase_number)
```

### Constants
**Format:** ALL_CAPS_SNAKE_CASE
**No prefix required** — all caps is already self identifying

```gdscript
const SPEED = 200.0
const DASH_SPEED = 600.0
const DASH_DURATION = 0.15
const IFRAME_DURATION = 0.5
```

### Variables
**Format:** snake_case
**No prefix** — context makes type clear

```gdscript
var is_dashing = false
var dash_timer = 0.0
var dash_cooldown_timer = 0.0
var dash_direction = Vector2.ZERO
var is_invulnerable = false
```

### Node References
**Prefix:** `node_`
**Format:** `node_` + descriptive name
**Always use @onready**

```gdscript
@onready var node_sprite = $Sprite2D
@onready var node_hurtbox = $Hurtbox
@onready var node_animation_player = $AnimationPlayer
@onready var node_animation_tree = $AnimationTree
@onready var node_collision = $CollisionShape2D
@onready var node_shader_material = $Sprite2D.material as ShaderMaterial
```

### Exported Variables
**Prefix:** `exp_`
**Format:** `exp_` + descriptive name
**Used for values set in the Inspector**

```gdscript
@export var exp_player_scene : PackedScene
@export var exp_enemy_scene : PackedScene
@export var exp_enemy_count : int = 3
```

### Public Functions
**Format:** snake_case, no prefix
**These are functions called externally by other nodes or scripts**

```gdscript
func start_dash():
func take_damage(amount):
func reset_dash_cooldown():
func trigger_phase(phase_number):
```

### Private Functions and Signal Handlers
**Prefix:** single underscore `_`
**These are functions called internally or by Godot automatically**

```gdscript
func _ready():
func _physics_process(delta):
func _on_sig_dash_started():
func _on_sig_invulnerability_ended():
func _handle_dash_timers(delta):
```

### Signal Handler Naming
Signal handlers follow a specific pattern combining the underscore prefix
with the signal name they respond to:

**Format:** `_on_` + signal name

```gdscript
# Signal defined as:
signal sig_dash_started(direction)

# Handler named as:
func _on_sig_dash_started(direction):
```

---

## File and Scene Naming

### Script Files
**Format:** snake_case
**Suffix:** `.gd`

```
player_movement.gd
leg_assembly.gd
attack_cycle_manager.gd
visual_effects_manager.gd
```

### Scene Files
**Format:** snake_case
**Suffix:** `.tscn`

```
player.tscn
leg_assembly.tscn
debug_room.tscn
debug_room_template.tscn
```

### Autoload Scripts
**Format:** PascalCase for the autoload name, snake_case for the file

```
File:     combat_system.gd
Autoload: CombatSystem

File:     visual_effects_manager.gd
Autoload: VisualEffectsManager

File:     game_state.gd
Autoload: GameState

File:     audio_manager.gd
Autoload: AudioManager
```

---

## Script Organisation

Scripts should always be organised in this order from top to bottom:

```gdscript
extends [NodeType]

# 1. Class name (if needed)
class_name PlayerMovement

# 2. Signals
signal sig_dash_started(direction)
signal sig_dash_ended

# 3. Constants
const SPEED = 200.0
const DASH_SPEED = 600.0

# 4. Exported variables
@export var exp_dash_enabled : bool = true

# 5. Public variables
var is_dashing = false

# 6. Private variables
var _dash_timer = 0.0

# 7. Onready node references
@onready var node_sprite = $Sprite2D
@onready var node_hurtbox = $Hurtbox

# 8. Built in Godot functions
func _ready():
func _physics_process(delta):
func _input(event):

# 9. Public functions
func start_dash():
func take_damage(amount):

# 10. Private functions and signal handlers
func _handle_dash_timers(delta):
func _on_sig_dash_started(direction):
```

---

## Comments

### Section dividers
Use a comment divider between major sections of a script:

```gdscript
# ─────────────────────────────────────────
# MOVEMENT
# ─────────────────────────────────────────
```

### Inline comments
Explain why, not what. The code says what it does.
The comment explains why it does it that way:

```gdscript
# Fallback prevents a zero length dash if the player is standing still
if direction == Vector2.ZERO:
    direction = Vector2.RIGHT
```

### Stopped here comments
When ending a session mid-script, always leave a comment:

```gdscript
# STOPPED HERE — signal connected but handler not yet written
# Next step: write _on_sig_dash_started body and test with debug print
```

### TODO comments
For known missing pieces:

```gdscript
# TODO: connect to IFrameManager when that node is built
# TODO: add approach vector capture for combat system
```

---

## General Rules

- One script per node — scripts should not try to do too many things
- Signals communicate upward and sideways in the scene tree
- Direct references communicate downward to child nodes
- Never skip the naming convention for speed — inconsistency compounds
- When in doubt about a name, make it longer and more descriptive
- Private variables that should never be touched externally can use
  a double underscore prefix: `__internal_timer`

### A Note on Public and Private Functions
GDScript does not enforce public or private access at the language level.
Every function is technically callable from outside its script regardless
of naming. The underscore convention is self enforced discipline, not a
compiler guarantee.

This means the convention only works if you respect it. Calling a function
prefixed with an underscore from outside its script will not cause an error
but it breaks the contract established by the naming system. If a function
has an underscore it should be treated as internal even though nothing
forces that.

This is a meaningful difference from languages like C# or Java where
private is a keyword the compiler enforces. In GDScript the developer
is trusted to follow their own rules. That trust requires conscious
discipline to maintain.

When in doubt about whether a function should be public or private ask:
should anything outside this script be able to call this directly?
If yes, no underscore. If no, underscore.

---

## Instruction for Antigravity's Claude

At the start of any session involving code generation, paste this:

```
Before writing any code today, read docs/code_conventions.md and
follow all naming and organisation conventions defined there.
Signals use sig_ prefix, node references use node_ prefix,
exported variables use exp_ prefix, signal handlers use _on_
prefix. Organise scripts in the order defined in the document.
```
